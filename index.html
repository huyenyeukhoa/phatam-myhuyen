<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ti·∫øng Trung M·ªπ Huy·ªÅn - Login</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mali:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #5c7a29; /* Xanh r√™u */
            --secondary: #9abf8a;
            --bg-paper: #f4f1e8;
            --bg-darker: #e8e4d5;
            --text-color: #3b3b3b;
            --highlight: #8c9e5e;
            --shadow-soft: 0 4px 10px rgba(61, 107, 83, 0.2);
            --border-deco: 3px double var(--primary);
        }
        
        body {
            font-family: 'Mali', cursive, sans-serif;
            margin: 0; padding: 0;
            background-color: var(--bg-paper);
            background-image: linear-gradient(to right, rgba(0,0,0,0.02) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            color: var(--text-color);
        }
        
        /* HEADER & NAV */
        header {
            background: var(--primary); color: var(--bg-paper); padding: 1rem; text-align: center;
            position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-soft);
            border-bottom: 4px solid #4a6320;
        }
        
        nav { display: flex; justify-content: center; background: var(--bg-darker); border-bottom: 2px solid var(--primary); flex-wrap: wrap; }
        nav button {
            flex: 1; padding: 12px 5px; border: none; background: none; font-size: 16px; min-width: 80px;
            font-family: 'Mali'; color: var(--primary); cursor: pointer; border-right: 1px dashed var(--secondary);
            transition: 0.2s;
        }
        nav button.active { background: var(--bg-paper); font-weight: bold; box-shadow: inset 0 -3px 0 var(--primary); color: #2e4010; }
        nav button:hover:not(.active) { background: rgba(154, 191, 138, 0.3); }

        /* Sub Nav */
        .sub-nav { display: flex; justify-content: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
        .sub-nav button {
            background: var(--bg-darker); border: 1px solid var(--primary); border-radius: 20px;
            padding: 5px 15px; cursor: pointer; color: var(--text-color); font-family: 'Mali';
        }
        .sub-nav button.active { background: var(--primary); color: white; }

        /* MAIN */
        main { padding: 20px; max-width: 900px; margin: 0 auto; margin-bottom: 80px; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h3 { color: var(--primary); border-bottom: 2px dashed var(--secondary); padding-bottom: 5px; }

        /* GRID */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .card {
            background: var(--highlight); color: white; border: 1px solid #758a43; border-radius: 8px;
            padding: 15px 5px; text-align: center; box-shadow: var(--shadow-soft); cursor: pointer;
            font-size: 24px; font-weight: bold; transition: 0.2s; 
            display: flex; justify-content: center; align-items: center; min-height: 60px;
        }
        .card:hover { transform: translateY(-3px); background-color: var(--primary); }

        /* MODAL */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 54, 0.9); z-index: 1000; justify-content: center; align-items: center; overflow-y: auto;
        }
        .modal-content {
            background: var(--bg-paper); padding: 25px; border-radius: 15px; width: 95%; max-width: 600px;
            text-align: center; position: relative; border: var(--border-deco); margin: 20px 0;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 30px; color: var(--primary); cursor: pointer; }

        .big-char { font-size: 80px; color: var(--primary); margin: 10px 0; line-height: 1; text-shadow: 2px 2px 0 var(--secondary); }
        .desc-line { font-size: 18px; color: var(--text-color); font-style: italic; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px; }
        
        /* AUDIO CONTROL */
        .audio-box { margin-top: 20px; background: var(--bg-darker); padding: 15px; border-radius: 10px; }
        .btn-play {
            background: var(--primary); color: white; border: none; width: 50px; height: 50px; border-radius: 50%;
            font-size: 24px; cursor: pointer; box-shadow: 0 4px #3d5216; transition: 0.1s;
        }
        .btn-play:active { transform: translateY(4px); box-shadow: none; }
        .input-link { width: 90%; padding: 8px; margin: 10px 0; border: 1px solid var(--primary); border-radius: 5px; }
        
        /* --- CSS M·ªöI CHO THANH ƒêI·ªÜU (H√ÄNG NGANG) --- */
        #tone-rows-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa c√°c th·∫ª */
            margin-top: 20px;
        }

        .tone-card {
            background: white;
            border: 2px solid var(--secondary);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px; /* ƒê·ªô r·ªông th·∫ª */
            box-shadow: var(--shadow-soft);
        }

        .tone-char-big {
            font-size: 60px; /* Ph√≥ng to ch·ªØ */
            font-weight: bold;
            color: var(--primary);
            line-height: 1.2;
        }

        .tone-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 5px;
        }

        .btn-play-small { 
            width: 40px; height: 40px; border-radius: 50%; 
            background: var(--primary); color: white; border: none; cursor: pointer; font-size: 18px;
        }
        
        /* H·ªôp input nh·ªè trong card */
        .mini-input-box {
            display: none;
            width: 100%;
            margin-top: 5px;
        }
        .input-link-mini {
            width: 100%;
            font-size: 10px;
            padding: 3px;
            border: 1px solid var(--secondary);
            border-radius: 4px;
            box-sizing: border-box;
            margin-bottom: 3px;
        }

        /* PRACTICE & RULES */
        .rule-box { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 5px solid var(--primary); }
        .rule-title { font-weight: bold; font-size: 18px; color: var(--primary); margin-bottom: 5px; }
        
        .practice-controls { background: var(--bg-paper); padding: 20px; border-radius: 15px; border: var(--border-deco); }
        textarea { width: 100%; height: 80px; margin-top: 10px; padding: 10px; box-sizing: border-box; border: 2px solid var(--secondary); border-radius: 8px; font-family: 'Mali'; }
        
        .flashcard {
            background: var(--bg-paper); height: 250px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; font-size: 100px; border-radius: 15px;
            margin-top: 25px; border: var(--border-deco); color: var(--primary); box-shadow: var(--shadow-soft);
        }

        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-family: 'Mali'; font-weight: bold; margin: 5px; }
        .btn-small { background: var(--secondary); color: #fff; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        
        .data-mgr { margin-top: 30px; border-top: 2px dashed var(--primary); padding-top: 20px; }
        .data-area { display: none; width: 100%; height: 100px; margin-top: 10px; font-family: monospace; font-size: 12px; }

        /* --- LOGIN STYLES --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-paper);
            background-image: linear-gradient(to right, rgba(0,0,0,0.02) 1px, transparent 1px), linear-gradient(to bottom, rgba(0,0,0,0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .login-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            border: var(--border-deco);
            box-shadow: var(--shadow-soft);
            text-align: center;
            width: 300px;
            animation: fadeIn 0.5s;
        }

        .login-title {
            color: var(--primary);
            font-size: 24px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .login-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid var(--secondary);
            border-radius: 8px;
            font-family: 'Mali';
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }
        
        .login-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 5px rgba(92, 122, 41, 0.3);
        }

        .login-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-family: 'Mali';
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
            transition: 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #app-content {
            display: none; /* ·∫®n n·ªôi dung ch√≠nh ban ƒë·∫ßu */
        }
        
        .error-msg {
            color: #d32f2f;
            font-size: 14px;
            margin-top: 10px;
            min-height: 20px;
            font-weight: bold;
        }

    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-box">
        <div class="login-title">üîê ƒêƒÉng Nh·∫≠p</div>
        <input type="text" id="login-user" class="login-input" placeholder="T√™n ƒëƒÉng nh·∫≠p" onkeypress="handleEnter(event)">
        <input type="password" id="login-pass" class="login-input" placeholder="M·∫≠t kh·∫©u" onkeypress="handleEnter(event)">
        <button class="login-btn" onclick="checkLogin()">V√†o H·ªçc</button>
        <div id="login-error" class="error-msg"></div>
    </div>
    <div style="margin-top: 20px; color: var(--primary); font-size: 14px;">Ti·∫øng Trung M·ªπ Huy·ªÅn</div>
</div>

<div id="app-content">

    <header>
        <h1>Ti·∫øng Trung M·ªπ Huy·ªÅn</h1>
    </header>

    <nav>
        <button class="nav-btn active" onclick="switchTab('thanh-mau')">Thanh M·∫´u</button>
        <button class="nav-btn" onclick="switchTab('van-mau')">V·∫≠n M·∫´u</button>
        <button class="nav-btn" onclick="switchTab('thanh-dieu')">Thanh ƒêi·ªáu</button>
        <button class="nav-btn" onclick="switchTab('quy-tac')">Quy T·∫Øc</button>
        <button class="nav-btn" onclick="switchTab('luyen-tap')">Luy·ªán T·∫≠p</button>
    </nav>

    <main>
        <div id="thanh-mau" class="section active">
            <h3>Thanh M·∫´u (23)</h3>
            <div class="grid-container" id="initials-grid"></div>
        </div>

        <div id="van-mau" class="section">
            <h3>V·∫≠n M·∫´u (24)</h3>
            <div class="grid-container" id="finals-grid"></div>
        </div>

        <div id="thanh-dieu" class="section">
            <div class="sub-nav">
                <button class="active" onclick="renderTones('single')">ƒê∆°n V·∫≠n M·∫´u</button>
                <button onclick="renderTones('compound')">K√©p/ƒê·∫∑c Bi·ªát</button>
                <button onclick="renderTones('nasal')">M≈©i (An/Ang)</button>
                <button onclick="renderTones('whole')">√Çm Ti·∫øt Tr·ªçn V·∫πn</button>
            </div>
            
            <h3 id="tone-group-title">ƒê∆°n V·∫≠n M·∫´u</h3>
            <p style="font-size: 14px; font-style: italic;">* B·∫•m v√†o √¥ ƒë·ªÉ h·ªçc 4 thanh ƒëi·ªáu.</p>
            <div class="grid-container" id="tones-grid"></div>
        </div>

        <div id="quy-tac" class="section">
            <h3>C√°c Quy T·∫Øc Bi·∫øn √Çm</h3>
            
            <div class="rule-box">
                <div class="rule-title">1. Bi·∫øn ƒëi·ªáu Thanh 3 (v)</div>
                <p>Khi hai thanh 3 ƒëi li·ªÅn nhau, thanh 3 th·ª© nh·∫•t ƒë·ªçc th√†nh <b>thanh 2</b>.</p>
                <p>V√≠ d·ª•: N«ê h«éo (v v) ‚ûú ƒê·ªçc l√†: <b>N√≠ h«éo</b> (/ v)</p>
            </div>

            <div class="rule-box">
                <div class="rule-title">2. Bi·∫øn ƒëi·ªáu ch·ªØ "B√π" (‰∏ç)</div>
                <p>- B√¨nh th∆∞·ªùng ƒë·ªçc l√† <b>b√π</b> (thanh 4).</p>
                <p>- Khi ƒëi tr∆∞·ªõc m·ªôt thanh 4 kh√°c, ƒë·ªçc th√†nh <b>b√∫</b> (thanh 2).</p>
                <p>V√≠ d·ª•: B√π sh√¨ ‚ûú <b>B√∫ sh√¨</b> (Kh√¥ng ph·∫£i).</p>
            </div>

            <div class="rule-box">
                <div class="rule-title">3. Bi·∫øn ƒëi·ªáu ch·ªØ "Yƒ´" (‰∏Ä)</div>
                <p>- S·ªë ƒë·∫øm ƒë·ªçc l√† <b>yƒ´</b> (thanh 1).</p>
                <p>- Tr∆∞·ªõc thanh 4: ƒë·ªçc th√†nh <b>y√≠</b> (thanh 2). Vd: Y√≠ g√® (m·ªôt c√°i).</p>
                <p>- Tr∆∞·ªõc thanh 1, 2, 3: ƒë·ªçc th√†nh <b>y√¨</b> (thanh 4). Vd: Y√¨ bƒõn (m·ªôt quy·ªÉn).</p>
            </div>
        </div>

        <div id="luyen-tap" class="section">
            <div class="practice-controls">
                <h3>D·ªØ Li·ªáu Luy·ªán T·∫≠p</h3>
                <div style="background: var(--bg-darker); padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                    <label>üìÇ Ch·ªçn b√†i:</label>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <select id="preset-select" onchange="loadPreset()"><option value="">-- Ch·ªçn b√†i --</option></select>
                        <button class="btn-small" onclick="deletePreset()">X√≥a</button>
                    </div>
                </div>

                <textarea id="practice-input" placeholder="Nh·∫≠p t·ª´: ba, ma, ni hao..."></textarea>
                
                <div class="preset-manager" style="margin-top:10px; display:flex; gap:5px;">
                    <input type="text" id="preset-name" placeholder="T√™n b√†i (vd: B√†i 1)" style="flex:1; padding:5px; border-radius:5px; border:1px solid #ccc;">
                    <button class="btn-small" onclick="savePreset()">üíæ L∆∞u</button>
                </div>
                
                <hr style="border: 0; border-top: 1px dashed var(--primary); margin: 15px 0;">
                
                <div style="text-align: center;">
                    <button class="btn-main" onclick="startPractice()">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
                    <div style="margin-top: 10px;">
                        <span style="font-weight: bold; color: var(--primary);">üîç C·ª° ch·ªØ:</span>
                        <button class="btn-small" onclick="changeFontSize(10)">+</button>
                        <button class="btn-small" onclick="changeFontSize(-10)">-</button>
                    </div>
                </div>
            </div>

            <div class="flashcard" id="practice-card">
                <div id="practice-word">...</div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                 <button class="btn-main" style="background: var(--secondary); color: var(--text-color);" onclick="nextWord()">Ti·∫øp theo ‚ûú</button>
            </div>

            <div class="data-mgr">
                <h3>üóÇÔ∏è Qu·∫£n L√Ω D·ªØ Li·ªáu</h3>
                <p>L∆∞u file √¢m thanh v√† b√†i t·∫≠p ƒë·ªÉ chuy·ªÉn m√°y kh√°c.</p>
                <button class="btn-small" onclick="exportData()">üì§ Xu·∫•t</button>
                <button class="btn-small" onclick="importData()">üì• Nh·∫≠p</button>
                <textarea id="data-area" class="data-area" placeholder="D·ªØ li·ªáu..."></textarea>
            </div>
        </div>
    </main>

    <div id="modal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
            
            <h2 id="modal-title" style="color:var(--primary); margin:0;">Title</h2>

            <div id="modal-simple-content" style="display:none;">
                <div class="big-char" id="modal-char">A</div>
                <div class="desc-line" id="modal-desc">M√¥ t·∫£</div> 
                <div class="audio-box">
                    <button class="btn-play" onclick="playAudioSimple()">üîä</button>
                    <div style="margin-top:10px; font-size:14px;">
                        <span onclick="toggleInput('simple-input')" style="cursor:pointer; text-decoration:underline; color:#666;">‚öôÔ∏è</span>
                        <div id="simple-input" style="display:none;">
                            <input type="text" id="inp-simple-link" class="input-link" placeholder="Link mp3...">
                            <button class="btn-small" onclick="saveLinkSimple()">L∆∞u</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="modal-tone-content" style="display:none; margin-top:20px;">
                <div id="tone-rows-container">
                    </div>
            </div>

        </div>
    </div>

</div> <script>
    /* --- LOGIN LOGIC --- */
    function checkLogin() {
        const u = document.getElementById('login-user').value;
        const p = document.getElementById('login-pass').value;
        const err = document.getElementById('login-error');

        if(u === 'thaovy' && p === '123456') {
            // ƒêƒÉng nh·∫≠p th√†nh c√¥ng
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            err.innerText = '';
            // T√πy ch·ªçn: L∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p (n·∫øu mu·ªën refresh kh√¥ng c·∫ßn nh·∫≠p l·∫°i th√¨ b·ªè comment d√≤ng d∆∞·ªõi)
            // sessionStorage.setItem('isLoggedIn', 'true');
        } else {
            err.innerText = '‚ö†Ô∏è Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!';
            document.getElementById('login-pass').value = ''; // X√≥a pass nh·∫≠p l·∫°i
        }
    }

    function handleEnter(e) {
        if(e.key === 'Enter') checkLogin();
    }

    /* --- D·ªÆ LI·ªÜU C≈® --- */
    const data = {
        initials: [
            { id: 'b', desc: '√Çm m√¥i: M√≠m hai m√¥i, kh√¥ng b·∫≠t h∆°i, d√¢y thanh kh√¥ng rung.' },
            { id: 'p', desc: '√Çm m√¥i: M√≠m hai m√¥i, B·∫¨T H∆†I m·∫°nh.' },
            { id: 'm', desc: '√Çm m√¥i: Hai m√¥i kh√©p, √¢m ra ƒë∆∞·ªùng m≈©i.' },
            { id: 'f', desc: '√Çm m√¥i rƒÉng: RƒÉng tr√™n ch·∫°m m√¥i d∆∞·ªõi, ƒë·∫©y h∆°i ra.' },
            { id: 'd', desc: '√Çm ƒë·∫ßu l∆∞·ª°i: ƒê·∫ßu l∆∞·ª°i ch·∫°m ch√¢n rƒÉng tr√™n.' },
            { id: 't', desc: '√Çm ƒë·∫ßu l∆∞·ª°i: Gi·ªëng d nh∆∞ng B·∫¨T H∆†I m·∫°nh.' },
            { id: 'n', desc: '√Çm m≈©i: ƒê·∫ßu l∆∞·ª°i ch·∫°m l·ª£i tr√™n, h∆°i ra m≈©i.' },
            { id: 'l', desc: 'ƒê·∫ßu l∆∞·ª°i cong l√™n ch·∫°m l·ª£i tr√™n, lu·ªìng h∆°i ƒëi hai b√™n l∆∞·ª°i.' },
            { id: 'g', desc: 'Cu·ªëng l∆∞·ª°i n√¢ng cao ch·∫°m ng·∫°c m·ªÅm.' },
            { id: 'k', desc: 'Gi·ªëng g nh∆∞ng B·∫¨T H∆†I m·∫°nh.' },
            { id: 'h', desc: 'H∆°i ma s√°t qua cu·ªëng l∆∞·ª°i (nh∆∞ kh·ªù nh·∫π ti·∫øng Vi·ªát).' },
            { id: 'j', desc: 'M·∫∑t l∆∞·ª°i √°p v√†o ng·∫°c c·ª©ng, mi·ªáng b√® ra.' },
            { id: 'q', desc: 'Gi·ªëng j nh∆∞ng B·∫¨T H∆†I m·∫°nh.' },
            { id: 'x', desc: 'H∆°i tho√°t qua k·∫Ω gi·ªØa m·∫∑t l∆∞·ª°i v√† ng·∫°c c·ª©ng.' },
            { id: 'zh', desc: 'Cu·ªën l∆∞·ª°i: ƒê·∫ßu l∆∞·ª°i cong l√™n, ch·∫°m ng·∫°c c·ª©ng.' },
            { id: 'ch', desc: 'Cu·ªën l∆∞·ª°i: Gi·ªëng zh nh∆∞ng B·∫¨T H∆†I m·∫°nh.' },
            { id: 'sh', desc: 'Cu·ªën l∆∞·ª°i: ƒê·∫ßu l∆∞·ª°i cong, h∆°i tho√°t ra ma s√°t.' },
            { id: 'r', desc: 'Cu·ªën l∆∞·ª°i: ƒê·∫ßu l∆∞·ª°i cong, d√¢y thanh rung.' },
            { id: 'z', desc: 'ƒê·∫ßu l∆∞·ª°i th·∫≥ng, ch·∫°m m·∫∑t sau rƒÉng c·ª≠a tr√™n.' },
            { id: 'c', desc: 'Gi·ªëng z nh∆∞ng B·∫¨T H∆†I m·∫°nh.' },
            { id: 's', desc: 'ƒê·∫ßu l∆∞·ª°i th·∫≥ng, h∆°i tho√°t qua k·∫Ω rƒÉng.' },
            { id: 'y', desc: 'ƒê·ªçc nh∆∞ ch·ªØ i (ho·∫∑c d·ªù nh·∫π) t√πy tr∆∞·ªùng h·ª£p.' },
            { id: 'w', desc: 'ƒê·ªçc nh∆∞ ch·ªØ u (ho·∫∑c g·ªù nh·∫π) t√πy tr∆∞·ªùng h·ª£p.' }
        ],
        finals: [
            { id: 'a', desc: 'M·ªü r·ªông mi·ªáng, l∆∞·ª°i xu·ªëng th·∫•p.' },
            { id: 'o', desc: 'M√¥i tr√≤n, l∆∞·ª°i r·ª•t v·ªÅ sau.' },
            { id: 'e', desc: 'Mi·ªáng h√©, kh√≥e mi·ªáng k√©o sang hai b√™n.' },
            { id: 'i', desc: 'Mi·ªáng d·∫πt, ƒë·∫ßu l∆∞·ª°i ch·∫°m rƒÉng d∆∞·ªõi.' },
            { id: 'u', desc: 'M√¥i tr√≤n nh√¥ ra tr∆∞·ªõc.' },
            { id: '√º', desc: 'Tr√≤n m√¥i ph√°t √¢m u nh∆∞ng v·ªã tr√≠ l∆∞·ª°i gi·ªëng i.' },
            { id: 'ai', desc: 'A tr∆∞·ª£t nh·∫π sang I (g·∫ßn nh∆∞ ai ti·∫øng Vi·ªát).' },
            { id: 'ei', desc: 'E tr∆∞·ª£t nh·∫π sang I (g·∫ßn nh∆∞ √¢y ti·∫øng Vi·ªát).' },
            { id: 'ui', desc: 'U tr∆∞·ª£t sang I (g·∫ßn nh∆∞ u√¢y).' },
            { id: 'ao', desc: 'A tr∆∞·ª£t sang O (g·∫ßn nh∆∞ ao).' },
            { id: 'ou', desc: 'O tr∆∞·ª£t sang U (g·∫ßn nh∆∞ √¢u).' },
            { id: 'iu', desc: 'I tr∆∞·ª£t sang U (g·∫ßn nh∆∞ i√™u).' },
            { id: 'ie', desc: 'I tr∆∞·ª£t sang E (g·∫ßn nh∆∞ i√™).' },
            { id: '√ºe', desc: '√ú tr∆∞·ª£t sang E (g·∫ßn nh∆∞ u√™).' },
            { id: 'er', desc: 'Cu·ªën l∆∞·ª°i l√™n (g·∫ßn nh∆∞ ∆°).' },
            { id: 'an', desc: 'A k·∫øt th√∫c b·∫±ng n (ƒë·∫ßu l∆∞·ª°i ch·∫°m l·ª£i).' },
            { id: 'en', desc: 'E k·∫øt th√∫c b·∫±ng n (g·∫ßn nh∆∞ √¢n).' },
            { id: 'in', desc: 'I k·∫øt th√∫c b·∫±ng n (g·∫ßn nh∆∞ in).' },
            { id: 'un', desc: 'U k·∫øt th√∫c b·∫±ng n (g·∫ßn nh∆∞ u√¢n).' },
            { id: '√ºn', desc: '√ú k·∫øt th√∫c b·∫±ng n (g·∫ßn nh∆∞ uyn).' },
            { id: 'ang', desc: 'A k·∫øt th√∫c b·∫±ng ng (mi·ªáng h√° to).' },
            { id: 'eng', desc: 'E k·∫øt th√∫c b·∫±ng ng (g·∫ßn nh∆∞ ung).' },
            { id: 'ing', desc: 'I k·∫øt th√∫c b·∫±ng ng (g·∫ßn nh∆∞ inh).' },
            { id: 'ong', desc: 'O k·∫øt th√∫c b·∫±ng ng (g·∫ßn nh∆∞ ung).' }
        ],
        toneGroups: {
            single: ['a','o','e','i','u','√º'],
            compound: ['ai','ei','ui','ao','ou','iu','ie','√ºe','er'],
            nasal: ['an','en','in','un','√ºn','ang','eng','ing','ong'],
            whole: ['zhi','chi','shi','ri','zi','ci','si','yi','wu','yu','ye','yue','yuan','yin','yun','ying']
        }
    };

    const toneMap = {
        'a': ['ƒÅ','√°','«é','√†'], 'o': ['≈ç','√≥','«í','√≤'], 'e': ['ƒì','√©','ƒõ','√®'],
        'i': ['ƒ´','√≠','«ê','√¨'], 'u': ['≈´','√∫','«î','√π'], '√º': ['«ñ','«ò','«ö','«ú']
    };
    
    function generate4Tones(base) {
        let v = '';
        if(base.includes('a')) v='a';
        else if(base.includes('o')) v='o';
        else if(base.includes('e')) v='e';
        else if(base.includes('i') && base.includes('u')) v = base.indexOf('i') > base.indexOf('u') ? 'i' : 'u'; 
        else if(base.includes('i')) v='i';
        else if(base.includes('u')) v='u';
        else if(base.includes('√º')) v='√º';
        
        if(base === 'ui') v = 'i';
        if(base === 'iu') v = 'u';

        if (!toneMap[v]) return [base, base, base, base];
        return toneMap[v].map(tChar => base.replace(v, tChar));
    }

    /* --- GLOBALS --- */
    let currentSimpleId = '';
    let currentToneBase = '';
    let practiceList = [];
    let currentPracticeIndex = 0;

    /* --- INIT --- */
    function init() {
        // Initials
        const initGrid = document.getElementById('initials-grid');
        data.initials.forEach(item => {
            let div = document.createElement('div');
            div.className = 'card';
            div.innerText = item.id; 
            div.onclick = () => showSimpleDetail(item.id, item.desc);
            initGrid.appendChild(div);
        });

        // Finals
        const finalGrid = document.getElementById('finals-grid');
        data.finals.forEach(item => {
            let div = document.createElement('div');
            div.className = 'card';
            div.innerText = item.id; 
            div.onclick = () => showSimpleDetail(item.id, item.desc);
            finalGrid.appendChild(div);
        });

        renderTones('single');
        loadPresetDropdown();

        // Check if previously logged in (Optional feature)
        // if(sessionStorage.getItem('isLoggedIn') === 'true') {
        //     document.getElementById('login-overlay').style.display = 'none';
        //     document.getElementById('app-content').style.display = 'block';
        // }
    }

    window.renderTones = function(groupKey) {
        document.querySelectorAll('.sub-nav button').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        const grid = document.getElementById('tones-grid');
        grid.innerHTML = '';
        
        const titles = {single:'ƒê∆°n V·∫≠n M·∫´u', compound:'K√©p/ƒê·∫∑c Bi·ªát', nasal:'M≈©i (An/Ang)', whole:'√Çm Ti·∫øt Tr·ªçn V·∫πn'};
        document.getElementById('tone-group-title').innerText = titles[groupKey];

        data.toneGroups[groupKey].forEach(base => {
            let div = document.createElement('div');
            div.className = 'card';
            div.style.backgroundColor = '#8c9e5e';
            div.innerText = base;
            div.onclick = () => showToneDetail(base);
            grid.appendChild(div);
        });
    }

    /* --- MODAL --- */
    window.closeModal = function(e) {
        if(e.target.id === 'modal') document.getElementById('modal').style.display='none';
    }

    function showSimpleDetail(id, desc) {
        currentSimpleId = id;
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Chi ti·∫øt";
        document.getElementById('modal-simple-content').style.display = 'block';
        document.getElementById('modal-tone-content').style.display = 'none';

        document.getElementById('modal-char').innerText = id;
        document.getElementById('modal-desc').innerText = desc;
        
        const saved = localStorage.getItem('audio_' + id) || '';
        document.getElementById('inp-simple-link').value = saved;
        document.getElementById('simple-input').style.display = 'none';
    }

    window.saveLinkSimple = function() {
        const val = document.getElementById('inp-simple-link').value;
        if(val) localStorage.setItem('audio_' + currentSimpleId, val);
        else localStorage.removeItem('audio_' + currentSimpleId);
        alert('ƒê√£ l∆∞u!');
    }

    window.playAudioSimple = function() {
        playUrl(localStorage.getItem('audio_' + currentSimpleId), currentSimpleId);
    }

    // --- MODAL THANH ƒêI·ªÜU (GIAO DI·ªÜN NGANG M·ªöI) ---
    function showToneDetail(base) {
        currentToneBase = base;
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Thanh ƒëi·ªáu: " + base;
        document.getElementById('modal-simple-content').style.display = 'none';
        document.getElementById('modal-tone-content').style.display = 'block';

        const container = document.getElementById('tone-rows-container');
        container.innerHTML = ''; // Reset

        const tones = generate4Tones(base); 

        tones.forEach((tChar, index) => {
            const toneNum = index + 1;
            const storageKey = 'audio_' + tChar; 
            const savedLink = localStorage.getItem(storageKey) || '';

            // T·∫°o th·∫ª card ƒë·ª©ng
            const card = document.createElement('div');
            card.className = 'tone-card';
            card.innerHTML = `
                <div class="tone-char-big">${tChar}</div>
                <div class="tone-controls">
                    <button class="btn-play-small" onclick="playUrl('${savedLink}', '${tChar}')">üîä</button>
                    <span onclick="toggleInput('inp-box-${toneNum}')" style="cursor:pointer; font-size:16px; color:#888;">‚öôÔ∏è</span>
                </div>
                
                <div id="inp-box-${toneNum}" class="mini-input-box">
                    <input type="text" id="inp-${storageKey}" class="input-link-mini" value="${savedLink}" placeholder="Link mp3...">
                    <button class="btn-small" style="font-size:10px; width:100%;" onclick="saveToneLink('${storageKey}')">L∆∞u</button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    window.saveToneLink = function(key) {
        const val = document.getElementById('inp-' + key).value;
        if(val) localStorage.setItem(key, val);
        else localStorage.removeItem(key);
        // Refresh l·∫°i modal
        const title = document.getElementById('modal-title').innerText;
        const base = title.split(': ')[1];
        showToneDetail(base);
    }

    /* --- HELPERS --- */
    window.toggleInput = function(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function playUrl(url, textFallback) {
        if(url && url.trim() !== '') {
            new Audio(url).play().catch(e => alert("L·ªói link: " + e.message));
        } else {
            const u = new SpeechSynthesisUtterance(textFallback);
            u.lang = 'zh-CN';
            speechSynthesis.speak(u);
        }
    }

    window.switchTab = function(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }

    /* --- PRACTICE --- */
    window.startPractice = function() {
        const txt = document.getElementById('practice-input').value;
        if(!txt.trim()) return alert("Nh·∫≠p t·ª´ ƒë√£!");
        practiceList = txt.split(/[\n,]+/).map(s=>s.trim()).filter(s=>s);
        if(!practiceList.length) return;
        
        practiceList.sort(() => Math.random() - 0.5);
        currentPracticeIndex = 0;
        showPracticeCard();
    }

    function showPracticeCard() {
        if(currentPracticeIndex >= practiceList.length) {
            if(confirm("H·∫øt b√†i! Luy·ªán l·∫°i?")) {
                currentPracticeIndex=0; 
                practiceList.sort(() => Math.random() - 0.5);
            } else return;
        }
        const word = practiceList[currentPracticeIndex];
        document.getElementById('practice-word').innerText = word;
    }

    window.nextWord = function() {
        if(!practiceList.length) return;
        currentPracticeIndex++;
        showPracticeCard();
        const word = practiceList[currentPracticeIndex] || practiceList[0];
        if(currentPracticeIndex < practiceList.length) {
             const saved = localStorage.getItem('audio_' + word);
        }
    }

    window.changeFontSize = function(n) {
        const card = document.getElementById('practice-card');
        let size = parseInt(window.getComputedStyle(card).fontSize);
        card.style.fontSize = (size + n) + 'px';
    }

    window.savePreset = function() {
        const name = document.getElementById('preset-name').value;
        const content = document.getElementById('practice-input').value;
        if(!name) return alert("Nh·∫≠p t√™n b√†i!");
        let presets = JSON.parse(localStorage.getItem('myPresets') || '{}');
        presets[name] = content;
        localStorage.setItem('myPresets', JSON.stringify(presets));
        loadPresetDropdown();
        alert("ƒê√£ l∆∞u!");
    }
    
    function loadPresetDropdown() {
        const sel = document.getElementById('preset-select');
        sel.innerHTML = '<option value="">-- Ch·ªçn b√†i --</option>';
        let presets = JSON.parse(localStorage.getItem('myPresets') || '{}');
        for(let k in presets) {
            let op = document.createElement('option');
            op.value = k; op.innerText = k;
            sel.appendChild(op);
        }
    }
    
    window.loadPreset = function() {
        const k = document.getElementById('preset-select').value;
        if(k) {
            let presets = JSON.parse(localStorage.getItem('myPresets') || '{}');
            document.getElementById('practice-input').value = presets[k];
        }
    }
    
    window.deletePreset = function() {
        const k = document.getElementById('preset-select').value;
        if(k && confirm('X√≥a b√†i n√†y?')) {
            let presets = JSON.parse(localStorage.getItem('myPresets') || '{}');
            delete presets[k];
            localStorage.setItem('myPresets', JSON.stringify(presets));
            loadPresetDropdown();
            document.getElementById('practice-input').value = '';
        }
    }

    window.exportData = function() {
        let data = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key.startsWith('audio_') || key === 'myPresets') {
                data[key] = localStorage.getItem(key);
            }
        }
        const jsonStr = JSON.stringify(data);
        const area = document.getElementById('data-area');
        area.style.display = 'block';
        area.value = jsonStr;
        area.select();
        document.execCommand('copy');
        alert("D·ªØ li·ªáu ƒë√£ hi·ªán ·ªü khung d∆∞·ªõi v√† ƒë∆∞·ª£c copy v√†o b·ªô nh·ªõ t·∫°m!");
    }

    window.importData = function() {
        const area = document.getElementById('data-area');
        area.style.display = 'block';
        const str = area.value.trim();
        if(!str) return alert("H√£y d√°n d·ªØ li·ªáu v√†o khung!");
        
        try {
            const data = JSON.parse(str);
            if(confirm("H√†nh ƒë·ªông n√†y s·∫Ω ghi ƒë√® c√°c d·ªØ li·ªáu tr√πng l·∫∑p. Ti·∫øp t·ª•c?")) {
                for(let key in data) {
                    localStorage.setItem(key, data[key]);
                }
                alert("Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng! Web s·∫Ω t·∫£i l·∫°i.");
                location.reload();
            }
        } catch(e) {
            alert("D·ªØ li·ªáu l·ªói, kh√¥ng ƒë·ªçc ƒë∆∞·ª£c!");
        }
    }

    init();
    
    // --- HOTKEY: SPACE (PH√çM C√ÅCH) ---
    document.addEventListener('keydown', function(e) {
        // Ki·ªÉm tra n·∫øu ch∆∞a ƒëƒÉng nh·∫≠p th√¨ kh√¥ng cho d√πng ph√≠m t·∫Øt
        if (document.getElementById('app-content').style.display === 'none') return;

        // 1. Ki·ªÉm tra n·∫øu ƒëang nh·∫≠p li·ªáu v√†o √¥ Input th√¨ KH√îNG ph√°t √¢m (ƒë·ªÉ b·∫°n g√µ link tho·∫£i m√°i)
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
            return; 
        }

        // 2. Ki·ªÉm tra ph√≠m C√ÅCH (Space)
        if (e.code === 'Space') {
            e.preventDefault(); // NgƒÉn tr√¨nh duy·ªát cu·ªôn trang xu·ªëng khi b·∫•m Space
            
            const modal = document.getElementById('modal');
            
            // N·∫øu Modal ƒëang ƒë√≥ng th√¨ kh√¥ng l√†m g√¨
            if(modal.style.display === 'none' || modal.style.display === '') return;

            const simpleDiv = document.getElementById('modal-simple-content');
            const toneDiv = document.getElementById('modal-tone-content');

            // TR∆Ø·ªúNG H·ª¢P 1: ƒêang xem Thanh M·∫´u / V·∫≠n M·∫´u -> Ph√°t 1 √¢m
            if(simpleDiv.style.display === 'block') {
                playAudioSimple();
            }

            // TR∆Ø·ªúNG H·ª¢P 2: ƒêang xem Thanh ƒêi·ªáu -> Ph√°t chu·ªói 4 thanh
            if(toneDiv.style.display === 'block' && currentToneBase) {
                playAll4Tones();
            }
        }
    });

    // H√†m ƒë·ªçc l·∫ßn l∆∞·ª£t 4 thanh ƒëi·ªáu
    function playAll4Tones() {
        if (!currentToneBase) return;

        const tones = generate4Tones(currentToneBase); // L·∫•y danh s√°ch 4 √¢m: ƒÅ, √°, «é, √†
        
        // ƒê·ªçc t·ª´ng √¢m c√°ch nhau 1.2 gi√¢y
        tones.forEach((tChar, index) => {
            setTimeout(() => {
                const savedLink = localStorage.getItem('audio_' + tChar);
                playUrl(savedLink, tChar);
            }, index * 1200); 
        });
    }
</script>

</body>
</html>